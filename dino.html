<!doctype html>
<title>Dino</title>
<link rel="stylesheet" href="http://yui.yahooapis.com/combo?3.3.0/build/cssreset/reset-min.css&amp;3.3.0/build/cssfonts/fonts-min.css&amp;3.3.0/build/cssgrids/grids-min.css">
<link rel="stylesheet" href="dino.css">

<h1>Dinoboard</h1>

<div id="tweets">
<p class="loading">Loading...</p>
</div>

<script src="http://l.yimg.com/py/yui-rls-3.3.0-min.js"></script>

<script>
YUI().use("node", "jsonp", "yql", "widget", "transition", function(Y) {
    var create = Y.Node.create,
        sub = Y.Lang.sub,
        BOUNDING_BOX = "boundingBox";

    function TweetBox() {
        TweetBox.superclass.constructor.apply(this, arguments);
    }

    TweetBox.NAME = "tweetbox";

    TweetBox.ATTRS = {
        query: {
            value: "#hacku OR from:hacku OR @hacku"
        },
        intervalTimer : {
            value: null
        },
        lastTweet : {
            value: 1
        },
        interval : {
            value: 45 * 1000,
            readOnly: true
        },
        limit: {
            value: 30
        },
        displayedIds: {
            value: []
        },
        tweetRegistry: {
            value: {}
        }
    };

    Y.extend(TweetBox, Y.Widget, {
        initializer: function () {
            var fn = Y.bind("_query", this);
            this.set("intervalTimer", this._periodic(fn));
            fn();
        },
        destructor: function () {
            this.get("intervalTimer").cancel();
        },
        search: function(config, cb) {
            config.query = encodeURIComponent(config.query);
            if (!("since" in config)) config.since = 1;
            console.log(config);
            Y.jsonp(sub("http://search.twitter.com/" +
                "search.json?callback={callback}&result_type=recent" +
                "&q={query}&since_id={since}", config), {
                on: {
                    success: cb,
                    failure: cb
                }
            });
        },
        _query: function () {
            console.log("periodic!");
            this.search({
                query: this.get("query"),
                since: this.get("lastTweet")
            }, Y.bind("syncUI", this));
        },
        _periodic: function (fn) {
            return Y.later(this.get("interval"), this,
                        fn, null, true);
        },
        renderUI: function() {
            var box = this.get("contentBox");

            var list = create("<ul class='tweets'></ul>");
            box.append(list);

            box.prepend(create(sub("<h2>Twitter: {q}</h2>", {
                q: this.get("query")
            })));
        },
        bindUI: function() {
        },
        syncUI: function(yql) {
            if (!yql) return;

            var limit = this.get("limit"),
                box = this.get(BOUNDING_BOX),
                list = box.one("ul"),
                displayedIds = this.get("displayedIds"),
                tweetRegistry = this.get("tweetRegistry"),
                newIds = [],
                newTweets = yql.results,
                loadingMessage = this.get("contentBox").one(".loading");

            if (loadingMessage) loadingMessage.remove();

            this.set("lastTweet", yql.max_id_str);

            // show new
            Y.each(newTweets, function (tweet) {
                if (tweet.id in tweetRegistry) return;
                tweetRegistry[tweet.id] = tweet;

                var tweet = create(sub(
                    '<li id="tweet-{id}">' +
                    '<div class="hcard"><img src="{profile_image_url}"' +
                    ' alt="{from_user}\'s Picture"><span>' +
                    '{from_user}</span></div><p>{text}</p></li>',
                    tweet
                ));
                tweet.setStyle("opacity", 0);
                box.append(tweet);
                tweet.transition({
                    easing: "ease-in",
                    duration: 0.75,
                    opacity: 1
                });

                // append to top
                newIds.unshift(tweet.id);

            });
                console.log(yql);

            console.log(displayedIds);

            // all these are now displayed
            displayedIds = newIds.concat(displayedIds);

            // remove greater than the limit from displayedIds
            // store removed ids
            var staleIds = displayedIds.splice(limit);

            // remove stale ids

            // make sure only max is displayed
            Y.each(staleIds, function (id) {
                box.one("#tweet-" + id).remove();
                delete tweetRegistry[id];
            });

            this.set("displayedIds", displayedIds);
            this.set("tweetRegistry", tweetRegistry);
        }
    });

    new TweetBox({
        query: "from:yahoo OR from:yuilibrary OR from:ydn",
        srcNode: "#tweets"
    }).render();
});
</script>
